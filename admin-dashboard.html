<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Data Mahasiswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .table-container {
            overflow-x: auto;
        }
        table {
            border-collapse: collapse;
        }
        th {
            position: sticky;
            top: 0;
            background: #4f46e5;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fas fa-user-graduate text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Dashboard Admin</h1>
                        <p class="text-indigo-100 text-sm">Sistem Data Alumni Mahasiswa</p>
                    </div>
                </div>
                
                <!-- User Info & Logout -->
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="font-semibold" id="adminName">Admin User</p>
                        <p class="text-xs text-indigo-100" id="adminEmail">admin@example.com</p>
                    </div>
                    <button 
                        id="btnLogout"
                        class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-50 transition flex items-center gap-2"
                    >
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Mahasiswa</p>
                        <p class="text-3xl font-bold text-indigo-600" id="totalMahasiswa">0</p>
                    </div>
                    <div class="bg-indigo-100 p-4 rounded-full">
                        <i class="fas fa-users text-indigo-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Alumni Bekerja</p>
                        <p class="text-3xl font-bold text-green-600" id="totalBekerja">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-full">
                        <i class="fas fa-briefcase text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Tahun Ini</p>
                        <p class="text-3xl font-bold text-purple-600" id="totalTahunIni">0</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-full">
                        <i class="fas fa-calendar text-purple-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons & Search -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <a 
                        href="tambah.html"
                        class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-green-600 hover:to-green-700 transition flex items-center gap-2 shadow-md"
                    >
                        <i class="fas fa-plus-circle"></i>
                        <span>Tambah Data</span>
                    </a>
                    
                    <button 
                        id="btnRefresh"
                        class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 transition"
                        title="Refresh Data"
                    >
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <div class="w-full md:w-96">
                    <div class="relative">
                        <input 
                            type="text"
                            id="searchInput"
                            placeholder="Cari berdasarkan NIM, Nama, Email..."
                            class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                        >
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="table-container">
                <table class="w-full">
                    <thead>
                        <tr class="bg-indigo-600 text-white">
                            <th class="px-4 py-3 text-left">No</th>
                            <th class="px-4 py-3 text-left">NIM</th>
                            <th class="px-4 py-3 text-left">Nama</th>
                            <th class="px-4 py-3 text-left">Tempat Lahir</th>
                            <th class="px-4 py-3 text-left">Tanggal Lahir</th>
                            <th class="px-4 py-3 text-left">Jenis Kelamin</th>
                            <th class="px-4 py-3 text-left">Jurusan</th>
                            <th class="px-4 py-3 text-left">Email</th>
                            <th class="px-4 py-3 text-left">No HP</th>
                            <th class="px-4 py-3 text-left">Tahun Keluar</th>
                            <th class="px-4 py-3 text-left">Pekerjaan</th>
                            <th class="px-4 py-3 text-left">Judul Skripsi</th>
                            <th class="px-4 py-3 text-left">Penguji Skripsi</th>
                            <th class="px-4 py-3 text-center sticky right-0 bg-indigo-600">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="14" class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Memuat data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Script Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDvcW5e0tzQqLuzQ4i4vff2D0Jkc09CMd8",
            authDomain: "data-alumni-b0381.firebaseapp.com",
            projectId: "data-alumni-b0381",
            storageBucket: "data-alumni-b0381.appspot.com",
            messagingSenderId: "852905518914",
            appId: "1:852905518914:web:71e503f91340991c3d4adb",
            measurementId: "G-Z8ZLBZDZKY"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        console.log("‚úÖ Firebase initialized");

        // === CEK SESSION ===
        function checkAuth() {
            const userSession = sessionStorage.getItem("user");
            if (!userSession) {
                alert("‚ùå Anda belum login! Silakan login terlebih dahulu.");
                window.location.href = "index.html";
                return null;
            }
            
            try {
                const user = JSON.parse(userSession);
                if (user.role !== "admin") {
                    alert("‚ùå Akses ditolak! Hanya admin yang bisa mengakses halaman ini.");
                    window.location.href = "index.html";
                    return null;
                }
                return user;
            } catch (e) {
                console.error("Session error:", e);
                window.location.href = "index.html";
                return null;
            }
        }

        const currentUser = checkAuth();
        if (currentUser) {
            document.getElementById("adminName").textContent = currentUser.nama || "Admin";
            document.getElementById("adminEmail").textContent = currentUser.email || "";
        }

        // === LOGOUT HANDLER ===
        document.getElementById("btnLogout").addEventListener("click", () => {
            if (confirm("Apakah Anda yakin ingin logout?")) {
                sessionStorage.removeItem("user");
                localStorage.removeItem("adminEmail");
                alert("‚úÖ Logout berhasil!");
                window.location.href = "index.html";
            }
        });

        // === LOAD DATA ===
        let allData = [];

        async function loadData() {
            const tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = `
                <tr>
                    <td colspan="14" class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Memuat data...</p>
                    </td>
                </tr>
            `;

            try {
                const q = query(collection(db, "mahasiswa"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);

                allData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log("üìä Data loaded:", allData.length, "documents");

                displayData(allData);
                updateStats(allData);

            } catch (err) {
                console.error("‚ùå Error loading data:", err);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="14" class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Gagal memuat data: ${err.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        // === DISPLAY DATA ===
        function displayData(data) {
            const tableBody = document.getElementById("tableBody");

            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="14" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>Belum ada data mahasiswa</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = data.map((item, index) => `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-4 py-3 font-semibold">${item.nim || '-'}</td>
                    <td class="px-4 py-3">${item.nama || '-'}</td>
                    <td class="px-4 py-3">${item.tempatLahir || '-'}</td>
                    <td class="px-4 py-3">${item.tanggalLahir || '-'}</td>
                    <td class="px-4 py-3">${item.jenisKelamin || '-'}</td>
                    <td class="px-4 py-3">${item.jurusan || '-'}</td>
                    <td class="px-4 py-3">${item.email || '-'}</td>
                    <td class="px-4 py-3">${item.noHp || '-'}</td>
                    <td class="px-4 py-3">${item.tahunKeluar || '-'}</td>
                    <td class="px-4 py-3">${item.pekerjaan || '-'}</td>
                    <td class="px-4 py-3 max-w-xs truncate" title="${item.judulSkripsi || '-'}">${item.judulSkripsi || '-'}</td>
                    <td class="px-4 py-3">${item.pengujiSkripsi || '-'}</td>
                    <td class="px-4 py-3 text-center sticky right-0 bg-white">
                        <div class="flex gap-2 justify-center">
                            <button 
                                onclick="editData('${item.id}')"
                                class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-sm"
                                title="Edit"
                            >
                                <i class="fas fa-edit"></i>
                            </button>
                            <button 
                                onclick="deleteData('${item.id}', '${item.nama}')"
                                class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition text-sm"
                                title="Hapus"
                            >
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // === UPDATE STATS ===
        function updateStats(data) {
            const total = data.length;
            const bekerja = data.filter(item => item.pekerjaan && item.pekerjaan.toLowerCase() !== 'belum bekerja').length;
            const tahunIni = data.filter(item => item.tahunKeluar == new Date().getFullYear()).length;

            document.getElementById("totalMahasiswa").textContent = total;
            document.getElementById("totalBekerja").textContent = bekerja;
            document.getElementById("totalTahunIni").textContent = tahunIni;
        }

        // === SEARCH ===
        document.getElementById("searchInput").addEventListener("input", (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = allData.filter(item => 
                (item.nim || '').toLowerCase().includes(keyword) ||
                (item.nama || '').toLowerCase().includes(keyword) ||
                (item.email || '').toLowerCase().includes(keyword) ||
                (item.jurusan || '').toLowerCase().includes(keyword)
            );
            displayData(filtered);
        });

        // === REFRESH ===
        document.getElementById("btnRefresh").addEventListener("click", () => {
            loadData();
        });

        // === DELETE DATA ===
        window.deleteData = async (id, nama) => {
            if (!confirm(`Apakah Anda yakin ingin menghapus data:\n\n${nama}?\n\nData yang dihapus tidak dapat dikembalikan!`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, "mahasiswa", id));
                console.log("‚úÖ Document deleted:", id);
                alert("‚úÖ Data berhasil dihapus!");
                loadData();
            } catch (err) {
                console.error("‚ùå Error deleting:", err);
                alert("‚ùå Gagal menghapus data: " + err.message);
            }
        };

        // === EDIT DATA ===
        window.editData = (id) => {
            window.location.href = `edit.html?id=${id}`;
        };

        // === INITIAL LOAD ===
        loadData();
    </script>
</body>
</html>
